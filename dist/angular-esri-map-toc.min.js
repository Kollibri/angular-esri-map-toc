!function(e){"use strict";e.module("esri.map.toc",[]).directive("esriToc",["$document","$q","$compile","$http",function(a,n,r,d){return{restrict:"E",replace:!0,link:function(l,t,o){var c=n.defer(),i=o.treeId;if(l.buildTOC=function(r){var t={};l.tocArray=[],l.tocArray.loaded=!1;var o=a[0].getElementsByTagName("esri-dynamic-map-service-layer");o.length===r.length&&e.forEach(r,function(a,c){var i=n.defer(),s=n.defer(),g=r[c].layer.url;i=d.get(g+"/legend?f=pjson"),s=d.get(g+"?f=pjson"),n.all([i,s]).then(function(a){var n=a[0],d=a[1],i=d.data,s=n.data,g=o[c].attributes["toc-Layers"].nodeValue,u=o[c].attributes["visible-Layers"].nodeValue,y=r[c].layer.id;l.mergedLists=[];var p=0;e.forEach(i.layers,function(a,n){-1!==g.indexOf(a.id)&&(t={},t.collapsed=!0,t.checked=-1!==u.indexOf(a.id),t.checked&&l.checkParents(a),t.layerId=a.id,t.mapServiceLayerId=y,t.layerName=a.name,t.subLayerIds=a.subLayerIds,t.parentLayerId=a.parentLayerId,e.isObject(t.subLayerIds)?p++:t.legend=s.layers[n-p].legend,l.mergedLists.push(t))});var f={};f.layerId=-1,f.checked=!0,f.collapsed=!0,f.layerName=r[c].title,f.mapServiceLayerId=y;var h={};h=l.buildTreeforTOC(f),l.tocArray.push(h),l.tocArray.loaded=!0})})},l.checkParents=function(a){e.forEach(l.mergedLists,function(e){e.layerId===a.parentLayerId&&(e.checked=!0,l.checkParents(e))})},l.buildTreeforTOC=function(a){return e.forEach(l.mergedLists,function(e){if(e.parentLayerId===a.layerId){var n=e;a.subLayers?a.subLayers.push(n):a.subLayers=[n],null!==n.subLayerIds&&l.buildTreeforTOC(n)}}),-1===a.layerId?a:void 0},l.refreshTOC=function(n){var d=o.mapId;e.isDefined(o.treeModel)&&(n=o.treeModel);var c='<p ng-show="!tocArray.loaded">Loading...</p><ul><li ng-repeat="parentNode in '+n+'"><div ng-if="parentNode.subLayers && parentNode.layerId == -1"><input type="checkbox" ng-click="'+i+'.toggleParentCheckbox(parentNode)" checked="true" value="-1"><i class="glyphicon glyphicon-plus" ng-show="parentNode.collapsed" ng-click="'+i+'.selectNodeHead(parentNode)"></i><i class="glyphicon glyphicon-minus" ng-show="!parentNode.collapsed" ng-click="'+i+'.selectNodeHead(parentNode)"></i><label>{{parentNode.layerName}}</label></div><ul ng-hide="parentNode.collapsed"><li data-ng-repeat="node in parentNode.subLayers"><input type="checkbox" ng-click="'+i+'.toggleNodeCheckbox(node);" ng-checked="{{node.checked}}" value="{{node.layerId}}"><i class="glyphicon glyphicon-plus" ng-show="(node.subLayers.length || node.legend.length > 1) && node.collapsed" ng-click="'+i+'.selectNodeHead(node)"></i><i class="glyphicon glyphicon-minus" ng-show="(node.subLayers.length || node.legend.length > 1) && !node.collapsed" ng-click="'+i+'.selectNodeHead(node)"></i><label ng-if="!node.legend">{{node.layerName}}</label><label ng-if="node.legend.length == 1"><img src="data:{{node.legend[0].contentType}};base64,{{node.legend[0].imageData}}"/>{{node.layerName}}</label><label ng-if="node.legend.length > 1">{{node.layerName}}</label><ul ng-hide="node.collapsed" ng-if="node.legend.length > 1"><li ng-repeat="legendNode in node.legend"><img src="data:{{legendNode.contentType}};base64,{{legendNode.imageData}}"/><span>{{(legendNode.label != "") ? legendNode.label : node.layerName }}</span></li></ul><esri-toc ng-hide="node.collapsed"tree-id="'+i+'"map-id="'+d+'"tree-model="[node]"></esri-toc></li></ul></li></ul>';if(i&&n)if(o.rootNode){var s=e.element(a[0].getElementById(d)).controller("esriMap");l[i]=l[i]||{},l[i].selectNodeHead=l[i].selectNodeHead||function(e){e.collapsed=!e.collapsed},l[i].toggleNodeCheckbox=l[i].toggleNodeCheckbox||function(a){s.getMap().then(function(n){e.forEach(n.layerIds,function(r){var d=[],t=[],o=[];if(-1===n.basemapLayerIds.indexOf(r)&&r===a.mapServiceLayerId){var c=n.getLayer(r);d=c.visibleLayers.map(function(e){return parseInt(e,10)}),a.checked=!a.checked,t=l[i].getLeafSubLayers(a,o),e.forEach(t,function(e){var n=d.indexOf(e.layerId);-1!==n?d.splice(n,1):!e.isParent&&a.checked&&e.checked&&e.parentsChecked&&d.push(e.layerId)}),0===d.length&&d.push(-1),c.setVisibleLayers(d)}})})},l[i].getLeafSubLayers=function(a,n){var r={};return r.layerId=a.layerId,r.checked=a.checked,r.isParent=e.isDefined(a.subLayers),r.parentsChecked=l[i].areAllParentsChecked(a),n.push(r),e.forEach(a.subLayers,function(e){l[i].getLeafSubLayers(e,n)}),n},l[i].areAllParentsChecked=function(a){var n=l[i].flattenToc(l.tocArray[0].subLayers,[]),r=[];r=l[i].getParents(n,a,r);var d=!0;return e.forEach(r,function(e){d=d&&e.checked}),d},l[i].flattenToc=function(a,n){return e.forEach(a,function(e){n.push(e),l[i].flattenToc(e.subLayers,n)}),n},l[i].getParents=function(a,n,r){return e.forEach(a,function(d){d.mapServiceLayerId===n.mapServiceLayerId&&d.layerId===n.parentLayerId&&(r.push(d),e.isDefined(d.subLayers)&&(r=l[i].getParents(a,d,r)))}),r},l[i].toggleParentCheckbox=l[i].toggleParentCheckbox||function(a){s.getMap().then(function(n){e.forEach(n.layerIds,function(e){if(n.basemapLayerIds!==e&&e===a.mapServiceLayerId){var r=n.getLayer(e);r.setVisibility(!r.visible)}})})};var g=o.targetId;e.element(a[0].getElementById(g)).html("").append(r(c)(l))}else t.html("").append(r(c)(l))},e.isDefined(o.mapId)&&e.isDefined(o.rootNode)){var s=o.mapId,g=e.element(a[0].getElementById(s)).controller("esriMap");l.$watchCollection(function(){return g.getLayerInfos()},function(a){l.layerInfos=a,e.isDefined(l.layerInfos)&&(l.buildTOC(l.layerInfos),l.refreshTOC("tocArray"),c.resolve())})}else l.refreshTOC()}}}])}(angular);